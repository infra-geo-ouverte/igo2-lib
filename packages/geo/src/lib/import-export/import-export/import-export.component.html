<div class="import-export-toggle mat-typography">
  <mat-button-toggle-group
        [value]="selectedMode"
        (change)="onImportExportChange($event)">
        <mat-button-toggle [value]="'import'">
          {{'igo.geo.importExportForm.importTabTitle' | translate}}
        </mat-button-toggle>
        <mat-button-toggle [value]="'export'">
          {{'igo.geo.importExportForm.exportTabTitle' | translate}}
        </mat-button-toggle>
  </mat-button-toggle-group>
</div>

<form class="igo-form" [formGroup]="importForm" *ngIf="selectedMode === 'import'">
  <div class="igo-input-container">
    <mat-form-field>
      <mat-label>{{'igo.geo.importExportForm.importProjPlaceholder' | translate}}</mat-label>
      <mat-select
        [(value)]="inputProj">
        <mat-option
          *ngFor="let projection of (projections$ | async)"
          [value]="projection"
          (click)="$event.stopPropagation()">
          <p mat-line *ngIf="projection.translateKey">{{('igo.geo.importExportForm.projections.' + projection.translateKey) | translate: projection}}</p>
          <p mat-line *ngIf="!projection.translateKey">{{projection.alias}}</p>
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div
    tooltip-position="below"
    matTooltipShowDelay="500"
    [matTooltip]="importForm.invalid ? ('igo.geo.importExportForm.projections.choose' | translate) : ('igo.geo.importExportForm.importButton' | translate)"
    class="igo-form-button-group">
    <button
      [disabled]="importForm.invalid || (loading$ | async)"
      mat-raised-button
      type="button"
      (click)="fileInput.click()">
        {{'igo.geo.importExportForm.importButton' | translate}}
    </button>
    <igo-spinner [shown]="loading$ | async"></igo-spinner>
    <input
      hidden
      #fileInput
      type="file"
      [style.display]="'none'"
      (click)="fileInput.value = null"
      (change)="importFiles($event.target.files)">
  </div>
</form>
<section class="mat-typography" *ngIf="selectedMode === 'import'">
  <h4>{{'igo.geo.importExportForm.importClarifications' | translate}}</h4>
  <ul>
    <li>{{'igo.geo.importExportForm.importSizeMax' | translate: {size: fileSizeMb} }}</li>
    <li>{{'igo.geo.importExportForm.importFormatAuthorized' | translate}}</li>
    <li>{{'igo.geo.importExportForm.importShpZip' | translate}}</li>
  </ul>
</section>

<section class="mat-typography" *ngIf="(exportableLayers$ | async).length === 0 && selectedMode === 'export'">
  <h4>{{'igo.geo.importExportForm.exportNoLayersExportable' | translate}}</h4>
</section>

<form class="igo-form" [formGroup]="form" *ngIf="(exportableLayers$ | async).length > 0 && selectedMode === 'export'">
  <div class="igo-input-container">
    <mat-form-field>
      <mat-label>{{'igo.geo.importExportForm.exportLayerPlaceholder' | translate}}</mat-label>
      <mat-select
        [(value)]="layers" multiple>
        <mat-select-trigger>
          {{layers.length ? getLayerTitleById(layers[0]) : ''}}
          <span *ngIf="layers.length > 1" class="export-select-trigger">
            (+{{layers.length - 1}} {{(layers?.length === 2 ? 'igo.geo.importExportForm.other' : 'igo.geo.importExportForm.others') | translate }})
          </span>
        </mat-select-trigger>
        <mat-option
          *ngFor="let layer of (exportableLayers$ | async)"
          [ngClass]="{'igo-export-layer-mat-option': layerHasSelectedFeatures(layer)}"
          [value]="layer.id"
          (click)="$event.stopPropagation()">
          <p mat-line>{{layer.title}}</p>
          <p mat-line>
            <mat-slide-toggle *ngIf="layerHasSelectedFeatures(layer)"
              [labelPosition]="'after'"
              (click)="onlySelectedClick($event,layer.id)"
              (checked)="inLayersIdToExportSelectionOnly(layer)"
              (change)="onlySelected($event,layer.id)">
              <small>{{'igo.geo.importExportForm.exportSelectedFeature' | translate}}</small>
            </mat-slide-toggle>
          </p>
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="igo-input-container">
    <mat-form-field>
      <mat-label>{{'igo.geo.importExportForm.exportFormatPlaceholder' | translate}}</mat-label>
      <mat-select
        formControlName="format">
        <ng-container *ngIf="(formats$ | async).length !== 0">
          <mat-option *ngFor="let format of (formats$ | async) | keyvalue" [value]="format.key">
            {{'igo.geo.export.format.' + format.value | translate}}
          </mat-option>
        </ng-container>
        <mat-option *ngIf="(formats$ | async).length === 0" disabled="true">
          {{'igo.geo.export.noFormat.title' | translate}}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="igo-input-container" *ngIf="forceNaming && form.value.format !== 'URL'">
    <mat-form-field>
        <input matInput formControlName="name" placeholder="{{'igo.geo.importExportForm.exportFileNamePlaceholder' | translate}}">
    </mat-form-field>
  </div>

  <div class="igo-input-container" *ngIf="form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon'">
    <mat-form-field>
      <mat-label>{{'igo.geo.importExportForm.encodingPlaceholder' | translate}}</mat-label>
      <mat-select
        formControlName="encoding">
        <ng-container *ngIf="(encodings$ | async).length !== 0">
          <mat-option *ngFor="let encoding of (encodings$ | async) | keyvalue" [value]="encoding.key">
            {{'igo.geo.export.encoding.' + encoding.value | translate}}
          </mat-option>
        </ng-container>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="export-options mat-typography" *ngIf="form.value.format !== 'URL'">
    <mat-slide-toggle
        formControlName="featureInMapExtent"
        [labelPosition]="'before'">
          {{'igo.geo.importExportForm.exportFeatureInExtent' | translate}}
    </mat-slide-toggle>
  </div>

  <div class="igo-form-button-group">
    <button
      mat-raised-button
      type="button"
      [disabled]="!form.valid || (loading$ | async)"
      (click)="handleExportFormSubmit(form.value)">
      {{form.value.format !== 'URL'  ? ('igo.geo.importExportForm.exportButton' | translate): (form.value.layers.length > 1  ? ('igo.geo.importExportForm.exportButtonLinks' | translate): ('igo.geo.importExportForm.exportButtonLink' | translate))}}
    </button>
    <igo-spinner [shown]="loading$ | async"></igo-spinner>
  </div>

</form>
