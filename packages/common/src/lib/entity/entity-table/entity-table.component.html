<div class="table-container" [ngStyle]="{ height: tableHeight }">
  <table
    id="currentWorkspaceTable"
    mat-table
    matSort
    [ngClass]="getTableClass()"
    [dataSource]="dataSource"
    (matSortChange)="onSort($event)"
  >
    <ng-container matColumnDef="selectionCheckbox" class="mat-cell-checkbox">
      <th mat-header-cell *matHeaderCellDef>
        <ng-container *ngIf="selectMany">
          <ng-container *ngIf="selectionState$ | async as selectionState">
            <mat-checkbox
              (change)="onToggleRows($event.checked)"
              [checked]="selectionState === entityTableSelectionState.All"
              [indeterminate]="
                selectionState === entityTableSelectionState.Some
              "
            >
            </mat-checkbox>
          </ng-container>
        </ng-container>
      </th>

      <td mat-cell *matCellDef="let row">
        <mat-checkbox
          (mousedown)="$event.shiftKey ? $event.preventDefault() : null"
          (click)="
            $event.shiftKey
              ? onShiftToggleRow(!rowIsSelected(row.record), row.record, $event)
              : $event.stopPropagation()
          "
          (change)="onToggleRow($event.checked, row.record)"
          [checked]="rowIsSelected(row.record)"
        >
        </mat-checkbox>
      </td>
    </ng-container>

    <ng-container
      *ngFor="let column of template.columns"
      [matColumnDef]="column.name"
    >
      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
        [disabled]="!columnIsSortable(column)"
        [matTooltip]="column.tooltip ? column.tooltip : undefined"
      >
        {{ column.title }}
      </th>

      <ng-container [ngSwitch]="column.renderer">
        <ng-container *ngSwitchCase="entityTableColumnRenderer.HTML">
          <td
            mat-cell
            *matCellDef="let row"
            [ngClass]="row.cellData[column.name].class"
          >
            <ng-container [ngSwitch]="column.type">
              <igo-entity-table-choice-cell
                *ngSwitchCase="
                  column.type === 'autocomplete' || column.type === 'list'
                    ? column.type
                    : ''
                "
                [column]="column"
                [record]="row.record"
              >
              </igo-entity-table-choice-cell>
              <igo-entity-table-default-cell
                *ngSwitchDefault
                [cellData]="row.cellData[column.name]"
              >
              </igo-entity-table-default-cell>
            </ng-container>
          </td>
        </ng-container>
        <ng-container *ngSwitchCase="entityTableColumnRenderer.UnsanitizedHTML">
          <ng-container *matCellDef="let row">
            <td
              *ngIf="isEdition(row.record); else isUnsanitizedHTML"
              mat-cell
              class="mat-cell-text edition"
              [formGroup]="formGroup"
              [ngClass]="row.cellData[column.name].class"
            >
              <ng-container [ngSwitch]="column.type">
                <mat-form-field
                  *ngSwitchCase="'date'"
                  subscriptSizing="dynamic"
                >
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="picker"
                  ></mat-datepicker-toggle>
                  <input
                    matInput
                    [matDatepicker]="picker"
                    [formControlName]="column.name"
                    value="{{ row.cellData[column.name].value }}"
                    (dateChange)="onDateChange(column.name, row.record, $event)"
                  />
                  <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>
                <mat-form-field
                  *ngSwitchCase="'time'"
                  subscriptSizing="dynamic"
                >
                  <input
                    matInput
                    type="time"
                    [formControlName]="column.name"
                    step="900"
                    (focus)="column.onFocus($event)"
                    (keypress)="column.onChange($event)"
                    (blur)="column.onBlur($event)"
                  />
                </mat-form-field>
                <mat-form-field
                  *ngSwitchCase="'number'"
                  subscriptSizing="dynamic"
                >
                  <input
                    matInput
                    type="number"
                    class="class_number_edition"
                    [formControlName]="column.name"
                    step="{{ column.step }}"
                    value="{{ row.cellData[column.name].value }}"
                    (input)="onValueChange(column.name, row.record, $event)"
                    readonly="{{
                      getValidationAttributeValue(column, 'readonly')
                    }}"
                    min="{{ getValidationAttributeValue(column, 'minValue') }}"
                    max="{{ getValidationAttributeValue(column, 'maxValue') }}"
                  />
                </mat-form-field>
                <mat-checkbox
                  *ngSwitchCase="'boolean'"
                  [formControlName]="column.name"
                  [checked]="row.cellData[column.name].value"
                  (change)="
                    onBooleanValueChange(column.name, row.record, $event)
                  "
                ></mat-checkbox>
                <igo-entity-select-field
                  *ngSwitchCase="'list'"
                  [control]="this.formGroup.get([column.name])"
                  [relation]="column.relation"
                  [domainValues]="column.domainValues"
                  [record]="row.record"
                  [multiple]="column.multiple"
                  (selected)="onSelectValueChange(column, row.record, $event)"
                ></igo-entity-select-field>

                <igo-entity-autocomplete-field
                  *ngSwitchCase="'autocomplete'"
                  [control]="this.formGroup.get([column.name])"
                  [relation]="column.relation"
                  [domainValues]="column.domainValues"
                  [record]="row.record"
                  (selected)="
                    onAutocompleteValueChange(column, row.record, $event)
                  "
                >
                </igo-entity-autocomplete-field>
                <mat-form-field *ngSwitchCaseDefault subscriptSizing="dynamic">
                  <input
                    matInput
                    type="text"
                    [formControlName]="column.name"
                    value="{{ row.cellData[column.name].value }}"
                    (input)="onValueChange(column.name, row.record, $event)"
                    readonly="{{
                      getValidationAttributeValue(column, 'readonly')
                    }}"
                  />
                </mat-form-field>
              </ng-container>
            </td>
            <ng-template #isUnsanitizedHTML>
              <td mat-cell [ngClass]="row.cellData[column.name].class">
                <ng-container [ngSwitch]="column.type">
                  <igo-entity-table-choice-cell
                    *ngSwitchCase="
                      column.type === 'autocomplete' || column.type === 'list'
                        ? column.type
                        : ''
                    "
                    [column]="column"
                    [record]="row.record"
                  >
                  </igo-entity-table-choice-cell>
                  <igo-entity-table-default-cell
                    *ngSwitchDefault
                    [cellData]="row.cellData[column.name]"
                  >
                  </igo-entity-table-default-cell>
                </ng-container>
              </td>
            </ng-template>
          </ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="entityTableColumnRenderer.Icon">
          <td
            mat-cell
            *matCellDef="let row"
            class="mat-cell-text"
            [ngClass]="row.cellData[column.name].class"
          >
            <mat-icon
              *ngIf="column.onClick"
              svgIcon="{{ row.cellData[column.name].value || column.icon }}"
              (click)="column.onClick($event)"
            ></mat-icon>
            <mat-icon
              *ngIf="!column.onClick"
              svgIcon="{{ row.cellData[column.name].value || column.icon }}"
            ></mat-icon>
          </td>
        </ng-container>
        <ng-container *ngSwitchCase="entityTableColumnRenderer.ButtonGroup">
          <td
            mat-cell
            *matCellDef="let row"
            class="mat-cell-text"
            [ngClass]="row.cellData[column.name].class"
          >
            <span *ngFor="let button of row.cellData[column.name].value">
              <ng-container
                *ngIf="
                  isEdition(row.record) === button.editMode ||
                  button.editMode === undefined
                "
              >
                <button
                  *ngIf="button.style === 'mat-icon-button'"
                  igoStopPropagation
                  mat-icon-button
                  [color]="button.color"
                  (mousedown)="onButtonClick(button.click, row.record)"
                  [disabled]="button.disabled"
                >
                  <mat-icon svgIcon="{{ button.icon }}"></mat-icon>
                </button>
                <button
                  *ngIf="button.style !== 'mat-icon-button'"
                  igoStopPropagation
                  mat-mini-fab
                  [color]="button.color"
                  (mousedown)="onButtonClick(button.click, row.record)"
                  [disabled]="button.disabled"
                >
                  <mat-icon svgIcon="{{ button.icon }}"></mat-icon>
                </button>
              </ng-container>
            </span>
          </td>
        </ng-container>
        <ng-container *ngSwitchDefault>
          <td
            mat-cell
            *matCellDef="let row"
            [ngClass]="row.cellData[column.name].class"
          >
            <ng-container [ngSwitch]="column.type">
              <igo-entity-table-choice-cell
                *ngSwitchCase="
                  column.type === 'autocomplete' || column.type === 'list'
                    ? column.type
                    : ''
                "
                [column]="column"
                [record]="row.record"
              >
              </igo-entity-table-choice-cell>
              <igo-entity-table-default-cell
                *ngSwitchDefault
                [cellData]="row.cellData[column.name]"
              >
              </igo-entity-table-default-cell>
            </ng-container>
          </td>
        </ng-container>
      </ng-container>
    </ng-container>

    <tr
      mat-header-row
      *matHeaderRowDef="headers; sticky: fixedHeader"
      [ngClass]="getHeaderClass()"
    ></tr>
    <tr
      mat-row
      igoEntityTableRow
      *matRowDef="let row; columns: headers"
      [scrollBehavior]="scrollBehavior"
      [ngClass]="getRowClass(row.record)"
      [selection]="selection"
      [selected]="rowIsSelected(row.record)"
      (select)="onRowSelect(row.record)"
      (click)="onRowClick(row.record)"
    ></tr>
  </table>
  <igo-entity-table-paginator
    *ngIf="withPaginator"
    [store]="store"
    [paginatorOptions]="paginatorOptions"
    [entitySortChange$]="entitySortChange$"
    (paginatorChange)="paginatorChange($event)"
  >
  </igo-entity-table-paginator>
</div>
