<igo-list [navigation]="true">
  <div class="context-filter-container">
    @if (showFilter()) {
      <mat-form-field floatLabel="always">
        <mat-label>{{
          'igo.context.contextManager.filterPlaceHolder' | translate
        }}</mat-label>
        <input
          matInput
          type="text"
          [placeholder]="
            'igo.context.contextManager.filterPlaceHolder' | translate
          "
          [(ngModel)]="term"
        />
        @if (term.length) {
          <button
            mat-icon-button
            matSuffix
            class="clear-button"
            aria-label="Clear"
            color="warn"
            (click)="clearFilter()"
          >
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>
    }

    <div class="actions-container">
      <button
        class="sort-alpha"
        [class.--active]="sortedAlpha"
        mat-icon-button
        [matTooltip]="
          'igo.context.contextManager.sortAlphabetically' | translate
        "
        matTooltipShowDelay="500"
        (click)="toggleSort()"
      >
        <mat-icon color="primary">sort_by_alpha</mat-icon>
      </button>

      @if (auth.authenticated && contextConfigs) {
        <igo-actionbar
          class="add-context-button"
          [iconColor]="color"
          [store]="actionStore"
          [withIcon]="true"
          icon="add"
          [withTitle]="actionbarMode === 'overlay'"
          [horizontal]="false"
          [mode]="actionbarMode"
        />
      }

      @if (auth.authenticated && contextConfigs) {
        <button
          class="users-filter"
          mat-icon-button
          [matTooltip]="'igo.context.contextManager.filterUser' | translate"
          matTooltipShowDelay="500"
          [matMenuTriggerFor]="accountMenu"
        >
          <mat-icon color="primary">filter_alt</mat-icon>
        </button>
      }
      <mat-menu #accountMenu="matMenu">
        @for (user of users; track user) {
          @if (!user.childs) {
            <button mat-menu-item class="profil-menu">
              <mat-checkbox
                [checked]="getPermission(user).checked"
                [indeterminate]="getPermission(user).indeterminate"
                (click)="$event.stopPropagation()"
                (change)="handleToggleCategory(user)"
              />
              <span>{{ user.title }}</span>
            </button>
          } @else {
            <button
              mat-menu-item
              [matMenuTriggerFor]="subAccountMenu"
              class="profil-menu"
            >
              <mat-checkbox
                [checked]="getPermission(user).checked"
                [indeterminate]="getPermission(user).indeterminate"
                (click)="$event.stopPropagation()"
                (change)="handleToggleCategory(user)"
              />
              <span>{{ user.title }}</span>
            </button>
            <mat-menu #subAccountMenu="matMenu">
              @for (child of user.childs; track child) {
                <button mat-menu-item class="profil-menu">
                  <mat-checkbox
                    [checked]="getPermission(child).checked"
                    (click)="$event.stopPropagation()"
                    (change)="handleToggleCategory(child, user)"
                  >
                    {{ child.title }}
                  </mat-checkbox>
                </button>
              }
            </mat-menu>
          }
        }

        <button mat-menu-item class="profil-menu">
          <mat-checkbox
            [checked]="showHidden"
            (click)="$event.stopPropagation()"
            (change)="showHiddenContexts.emit($event.checked)"
          />
          <span>
            {{ 'igo.context.contextManager.showHidden' | translate }}
          </span>
        </button>
      </mat-menu>
    </div>
  </div>

  @for (
    groupContexts of $any(contexts$ | async) | keyvalue;
    track groupContexts
  ) {
    @if ($any(groupContexts).value.length && auth.authenticated) {
      <igo-collapsible
        [title]="titleMapping[$any(groupContexts).key] | translate"
        [collapsed]="$any(collapsed[titleMapping[$any(groupContexts).key]])"
        (toggle)="
          collapsed[titleMapping[$any(groupContexts).key]] = $any($event)
        "
      >
        @for (context of $any(groupContexts).value; track context) {
          <igo-context-item
            igoListItem
            color="accent"
            [selected]="
              selectedContext() && selectedContext().uri === context.uri
            "
            [context]="context"
            [default]="
              context.id &&
              this.defaultContextId &&
              this.defaultContextId === context.id
            "
            (edit)="edit.emit(context)"
            (delete)="delete.emit(context)"
            (clone)="clone.emit(context)"
            (save)="save.emit(context)"
            (hide)="hideContext(context)"
            (show)="showContext(context)"
            (favorite)="favorite.emit(context)"
            (manageTools)="manageTools.emit(context)"
            (managePermissions)="managePermissions.emit(context)"
            (select)="onSelect(context)"
            (unselect)="unselect.emit(context)"
          />
        }
      </igo-collapsible>
    }
    @if ($any(groupContexts).value.length && !auth.authenticated; as context) {
      @for (context of $any(groupContexts).value; track context) {
        <igo-context-item
          igoListItem
          color="accent"
          [showFavorite]="
            configService.getConfig('favoriteContext4NonAuthenticated')
          "
          [selected]="
            selectedContext() && selectedContext().uri === context.uri
          "
          [context]="context"
          [default]="
            contextConfigs
              ? defaultContextId === context.id
              : defaultContextId === context.uri
          "
          (favorite)="favorite.emit(context)"
          (select)="select.emit(context)"
          (unselect)="unselect.emit(context)"
        />
      }
    }
  }

  @if (isEmpty) {
    <div class="no-result">
      {{ 'igo.context.contextManager.noResult' | translate }}
    </div>
  }
</igo-list>
